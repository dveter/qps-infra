# Configuration Guide

## Jenkins Setup

### GitHub Integration

[Github.com](github.com) is integrated by default. To override integration for Enterprise GitHub, GitLab etc declare the following global variables:
 <ul>
   <li>  Manage jenkins -> Configure System 
   <li>  Global properties -> Add Property 
       <ul>
       <li type="circle"> GITHUB_HOST -> github.mydomain.com
       <li type="circle"> GITHUB_ORGANIZATION -> myorganization
       <li type="circle"> GITHUB_API_URL -> https://$GITHUB_HOST/api/v3
       <li type="circle"> GITHUB_HTML_URL -> https://$GITHUB_HOST/$GITHUB_ORGANIZATION
       <li type="circle"> GITHUB_SSH_URL -> git@$GITHUB_HOST:$GITHUB_ORGANIZATION
       </ul>
 </ul>
 
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Enterprise.png?raw=true "Enterprise") 

### Set up "GitHub Pull Request Builder":

For every registered repository we do set of pre-validations like compilation and Sonar PR checker. Integration should be configured at once to make all OnPullRequest Jobs/Events auto-configurable

  * Open Jenkins -> Credentials
  * Update Username and Password for "ghprbhook-token" credentials   
  > Valid github username and password/token
  ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Credentials.png?raw=true "Credentials") 
  * Go to Manage Jenkins -> Configure System
  * Specify a value for GitHub Server API URL, for example, https://api.github.com
  > Note: corporate versions of GitHub should have a different value, for example, https://github.mydomain.com/api/v3
  * Provide GitHub credentials with Admin privileges for your organization
  * Check the "Auto-manage webhooks" param
  * [Optional] update "Commit Status Context" to a value such as qps-infra to identify that changes in GitHub PR are automatically generated by infra
  * Save changes and restart Jenkins

#### Test "GitHub Pull Request Builder" integration

  * Go to Manage Jenkins -> Configure System
  * Scroll to "GitHub Pull Request Builder" and click "Test Credentials"
  * Set Credentials -> Test basic connection to GitHub
  * Set Repository owner/name -> Test Permissions to a Repository
  * Set Issue ID/Comment -> Test adding comment to Pull Request

![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/TestGithub.png?raw=true "TestGithub") 

## SonarQube Setup

SonarQube is used for static code analysis in updated lines/files during pull requests validations and full code analysis for onPush.
That's guarantee a good quality of the code, effective code review process and fast engineering team skills growth.
In order to enable sonarqube the following components must be configured correctly.
   
### Create a [GitHub App](https://developer.github.com/apps/about-apps/)

  * Follow Steps 1â€“4 [here](https://developer.github.com/apps/building-github-apps/creating-a-github-app/) to start creating your GitHub App
  * Under **GitHub App name**, give your app name, such as SonarQubePRDecorator.
  * Add a **Homepage URL**. It is required in GitHub but not obligatory for Pull Request decoration. You can use any URL such as https://your.infra.domain.com/.
  * Enter your **User authorization callback URL**. Set this to your instance's base URL. 
  > Example: https://your.infra.domain.com/sonarqube/oauth2/callback
  * Add **Webhook URL**. Set this to your instance's base URL. For example, https://your.infra.domain.com/.
  * Grant access for the following **Permissions**:
   
      |Permission                | Access        |
      |:------------------------:|---------------|
      |      Checks              | Read & Write  |	
      |      Metadata            | Read-Only     | 
      |      Pull Requests       | Read & Write  |
      |      Commit statuses     | Read-only     |

  > Note: if your are using **Github Enterprise** the permission "Metadata" is renamed to "Repository Metadata"
  
  * Under "Where can this GitHub App be installed?," select **Any account.**
  * Click **Create GitHub App**. This will take you to your new GitHub App's page.
  * Scroll down to the bottom of your app page and click **Generate Private Key.** This downloads a .pem file that you'll use in the **Configure SonarQube server section.**
  
### Install your app

Installing your GitHub App from the app's settings page.

  * Go to your GitHub profile > Developer settings > GitHub Apps > Your app name > Install App
  * Select the organization to install the app
  * Select All repositories
  * Clik install

  
### Configure SonarQube server

In order to enable Pull Request decoration follow the next steps:

  * Go to your sonarqube server page and login.
  > Note: default credentials for sonar are: admin/admin, we recommend changing them after setting up the infra.
   
  * Add your SonarQube server under **Configuration > General Settings > Server base URL**
   
  ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/SonarBaseUrlConfig.png?raw=true "SonarBaseUrlConfig")
   
  * In **Configuration > GitHub** add your GitHub App **Client ID, Client Secret**
   
  ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/SonarGitHubConfig.png?raw=true "SonarGitHubConfig")
   
  * In **Configuration > Pull Request** add your GitHub **App ID, App Name, App Private Key and select Provider as GitHub**
   
  ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/SonarPullRequestConfig.png?raw=true "SonarPullRequestConfig")
   
  > Note: make sure to copy all content from the .pem file generated in the **Create GitHub App** section
  
  > Note: update **SONAR_URL** global Jenkins variable to point to private SonarQube instance
   
## Organization Setup  

### Register Organization

Each GitHub organization should be registered in Jenkins to be able to setup CI/CD process for different repositories inside.
   
  * Open Jenkins->Management_Jobs folder.
  * Run "RegisterOrganization" providing your GitHub organization name as folderName
  * _New folder is created with default content (launcher and RegisterRepository jobs)_
 
 ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Organization.png?raw=true "Organization")

### Register Repository

Repositories registration process save securely access credentials/tokens, setup high-level CI/CD process for test automation and do scanning and automatic jobs creation based on embedded JobDSL rules.

   * Open your organization folder
   * Run "RegisterRepository" pointing to your repository
   > Example: https://github.com/qaprosoft/carina-demo
   * Use neccessary runner class
   > Example: "com.qaprosoft.jenkins.pipeline.runner.maven.TestNG" for any **Maven + TestNG** repository
   * _Repository is scanned, TestNG jobs created for every suite file_
     
 ![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/Repository.png?raw=true "Repository")       

#### Setup GitHub WebHooks (onPush Job/Event)

To setup automatic onPush Jobs execution follow below steps. It guarantee automatic full static code analysis by SonarQube and flexible CI/CD process to recreate Test Automation jobs on CI

   * Go to your GitHub repository
   * Click "Settings" tab
   * Click "Webhooks" menu option
   * Click "Add webhook" button
   * Type http://your-jenkins-domain.com/jenkins/github-webhook/ into "Payload URL" field
   * Select application/json in "Content Type" field
   * Tick "Send me everything." option
   * Click "Add webhook" button
   * _After any push or merge into the master onPush-repo job is launched, suites scanned, TestNG jobs created_
        
![Alt text](https://github.com/qaprosoft/qps-infra/blob/master/docs/img/PushJobs.png?raw=true "PushJobs")

## Support Channel

  * Join [Telegram channel](https://t.me/qps_infra) in case of any question
